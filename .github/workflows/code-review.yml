name: Code Review

on:
  pull_request_target:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Get PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const changedFiles = files.map(f => f.filename);
            const additions = context.payload.pull_request.additions;
            const deletions = context.payload.pull_request.deletions;
            const changedFilesCount = changedFiles.length;

            let review = [];
            review.push('## üìã PR ÏûêÎèô Î¶¨Î∑∞\n');

            // Summary
            review.push('### üìä Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ ÏöîÏïΩ');
            review.push(`- üìÅ Î≥ÄÍ≤ΩÎêú ÌååÏùº: **${changedFilesCount}Í∞ú**`);
            review.push(`- ‚ûï Ï∂îÍ∞ÄÎêú Ï§Ñ: **${additions}Ï§Ñ**`);
            review.push(`- ‚ûñ ÏÇ≠Ï†úÎêú Ï§Ñ: **${deletions}Ï§Ñ**`);
            review.push('');

            // File categorization for docs
            const fileTypes = {
              markdown: [],
              images: [],
              configs: [],
              others: []
            };

            for (const file of changedFiles) {
              if (!file) continue;
              if (file.endsWith('.md')) fileTypes.markdown.push(file);
              else if (file.match(/\.(png|jpg|jpeg|gif|svg)$/i)) fileTypes.images.push(file);
              else if (file.endsWith('.json') || file.endsWith('.yml') || file.endsWith('.yaml')) fileTypes.configs.push(file);
              else fileTypes.others.push(file);
            }

            review.push('### üìÇ Î≥ÄÍ≤ΩÎêú ÌååÏùº Î∂ÑÎ•ò');
            if (fileTypes.markdown.length) review.push(`- üìù ÎßàÌÅ¨Îã§Ïö¥: ${fileTypes.markdown.length}Í∞ú`);
            if (fileTypes.images.length) review.push(`- üñºÔ∏è Ïù¥ÎØ∏ÏßÄ: ${fileTypes.images.length}Í∞ú`);
            if (fileTypes.configs.length) review.push(`- ‚öôÔ∏è ÏÑ§Ï†ï: ${fileTypes.configs.length}Í∞ú`);
            if (fileTypes.others.length) review.push(`- üì¶ Í∏∞ÌÉÄ: ${fileTypes.others.length}Í∞ú`);
            review.push('');

            // Post comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const botComment = comments.find(c => c.user.login === 'github-actions[bot]' && c.body.includes('PR ÏûêÎèô Î¶¨Î∑∞'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: review.join('\n')
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: review.join('\n')
              });
            }
